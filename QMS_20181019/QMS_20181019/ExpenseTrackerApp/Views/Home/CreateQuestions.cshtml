@using System.Data
@model DataSet
<style>
    .k-window.k-confirm .k-content {
        padding: 50px 50px;
    }
</style>
<div class="container">
    <button class="btn btn-primary" id="btnAddQues" data-toggle="modal" data-target="#addQuesModal"><span class="k-icon k-i-plus"></span>Add New Question</button>
       <br />
    <table id="gridQuestions"></table>
    <br />
    <div id="addQuesModal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Add Question</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="form-group col-md-4">
                            <label for="" class="control-label">Select Question Type</label>
                        </div>
                        <div class="form-group col-md-8">
                            <select id="ddlQuesType" style="width: 100%;" name="Question Type" required>
                                <option value="1">Single</option>
                                <option value="2">Multiple</option>
                                <option value="3">True/False</option>
                            </select>
                            <span class="k-invalid-msg" data-for="ddlQuesType"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group col-md-4">
                            <label for="" class="control-label">Select Category</label>
                        </div>
                        <div class="form-group col-md-8">
                            <input data-message="Please Select Value" name="Category" class="form-control" id="ddlCategory" required>
                            <span class="k-invalid-msg" data-for="ddlCategory"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group col-md-4">
                            <label for="" class="control-label">Question</label>
                        </div>
                        <div class="form-group col-md-8">
                            <input type="text" id="txtQuestion" class="form-control" name="Question" required>
                            <span class="k-invalid-msg" data-for="txtQuestion"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group col-md-4">
                            <label for="" class="control-label">Option A</label>
                        </div>
                        <div class="form-group col-md-8">
                            <input type="text" id="txtOptionA" maxlength="350" class="form-control" name="OptionA" required>
                            <span class="k-invalid-msg" data-for="txtOptionA"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group col-md-4">
                            <label for="" class="control-label">Option B</label>
                        </div>
                        <div class="form-group col-md-8">
                            <input type="text" id="txtOptionB" class="form-control" maxlength="350" name="OptionB" required>
                            <span class="k-invalid-msg" data-for="txtOptionB"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group col-md-4">
                            <label for="" class="control-label">Option C</label>
                        </div>
                        <div class="form-group col-md-8">
                            <input type="text" id="txtOptionC" class="form-control" maxlength="350" name="OptionC">
                            <span class="k-invalid-msg" data-for="txtOptionC"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group col-md-4">
                            <label for="" class="control-label">Option D</label>
                        </div>
                        <div class="form-group col-md-8">
                            <input type="text" id="txtOptionD" class="form-control" maxlength="350" name="OptionD">
                            <span class="k-invalid-msg" data-for="txtOptionD"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group col-md-4">
                            <label for="" class="control-label">Correct Answer</label>
                        </div>
                        <div class="form-group col-md-8">
                            <select id="ddlCorrectAns" style="width: 100%;" name="Question Type" required>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                            </select>
                            <select id="ddlmCorrectAns" style="width: 100%;" name="Question Type" multiple>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                            </select>
                            <span class="k-invalid-msg" data-for="ddlCorrectAns"></span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="SaveQuestion" class="btn btn-success">Add</button>
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
   
</div>
<script id="EditQuestion" type="text/x-kendo-template">
    <div class="panel-body" id="EditQuestionForm">
        <div class="row">
            <div class="form-group col-md-4">
                <label for="" class="control-label">Select Question Type</label>
            </div>
            <div class="form-group col-md-8">
                <select id="eddlQuesType" style="width: 100%;" name="Question Type" data-bind="value:ChoiceType" required>
                    <option value="Single">Single</option>
                    <option value="Multiple">Multiple</option>
                    <option value="True/False">True/False</option>
                </select>
                <span class="k-invalid-msg" data-for="eddlQuesType"></span>
            </div>
        </div>
        <div class="row">
            <div class="form-group col-md-4">
                <label for="" class="control-label">Select Category</label>
            </div>
            <div class="form-group col-md-8">
                <input data-message="Please Select Value" name="Category" data-bind="value:SubjectName" class="form-control" id="eddlCategory" required>
                <span class="k-invalid-msg" data-for="eddlCategory"></span>
            </div>
        </div>
        <div class="row">
            <div class="form-group col-md-4">
                <label for="" class="control-label">Question</label>
            </div>
            <div class="form-group col-md-8">
                <input type="text" id="etxtQuestion" class="form-control" data-bind="value:Question" name="Question" required>
                <span class="k-invalid-msg" data-for="etxtQuestion"></span>
            </div>
        </div>
        <div class="row">
            <div class="form-group col-md-4">
                <label for="" class="control-label">Option A</label>
            </div>
            <div class="form-group col-md-8">
                <input type="text" id="etxtOptionA" maxlength="350" data-bind="value:Option1" class="form-control" name="OptionA" required>
                <span class="k-invalid-msg" data-for="etxtOptionA"></span>
            </div>
        </div>
        <div class="row">
            <div class="form-group col-md-4">
                <label for="" class="control-label">Option B</label>
            </div>
            <div class="form-group col-md-8">
                <input type="text" id="etxtOptionB" class="form-control" data-bind="value:Option2" maxlength="350" name="OptionB" required>
                <span class="k-invalid-msg" data-for="etxtOptionB"></span>
            </div>
        </div>
        <div class="row">
            <div class="form-group col-md-4">
                <label for="" class="control-label">Option C</label>
            </div>
            <div class="form-group col-md-8">
                <input type="text" id="etxtOptionC" class="form-control" data-bind="value:Option3" maxlength="350" name="OptionC">
                <span class="k-invalid-msg" data-for="etxtOptionC"></span>
            </div>
        </div>
        <div class="row">
            <div class="form-group col-md-4">
                <label for="" class="control-label">Option D</label>
            </div>
            <div class="form-group col-md-8">
                <input type="text" id="etxtOptionD" class="form-control" data-bind="value:Option4" maxlength="350" name="OptionD">
                <span class="k-invalid-msg" data-for="etxtOptionD"></span>
            </div>
        </div>
        <div class="row">
            <div class="form-group col-md-4">
                <label for="" class="control-label">Correct Answer</label>
            </div>
            <div class="form-group col-md-8">
                <select id="eddlCorrectAns" style="width: 100%;" data-bind="value:Answer" name="Question Type" required>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                </select>
                <select id="eddlmCorrectAns" style="width: 100%;" data-bind="value:Answer" name="Question Type" multiple>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                </select>
                <span class="k-invalid-msg" data-for="eddlCorrectAns"></span>
            </div>
        </div>
    </div>
</script>
<script type="text/javascript">
            $(document).ready(function () {

                $('#addQuesModal').on('hidden.bs.modal', function (e) {
                    debugger;
                    //alert('jb jb modal band ho ja rha hai')
                    $(".modal-body input").val("");
                    //$('#ddlQuesType').val("1");
                    $("#ddlQuesType").data("kendoDropDownList").select(0);
                    $('#ddlQuesType option[value=1]').attr('selected', 'selected');
                    $("#ddlCategory").data("kendoDropDownList").select(0);
                    onChange();

                });

                $("#ddlmCorrectAns").hide();
                $("#ddlCorrectAns").show();
                $("#ddlCorrectAns").children('option:gt(1)').show();
                //$("#ddlCorrectAns").kendoDropDownList().data("kendoDropDownList");
                //$("#ddlmCorrectAns").kendoMultiSelect().data("kendoMultiSelect");
                $("#ddlQuesType").kendoDropDownList(
                    {
                        change: onChange
                    }).data("kendoDropDownList");
                function onChange() {
                    debugger;
                    var val = $('#ddlQuesType').val();
                    if (val == 1) {
                        $('#txtOptionA').val('');
                        $('#txtOptionB').val('');
                        $("#txtOptionC").attr("disabled", false);
                        $("#txtOptionD").attr("disabled", false);
                        $("#ddlmCorrectAns").hide();
                        $("#ddlCorrectAns").show();
                        $("#ddlCorrectAns").children('option:gt(1)').show();
                    }
                    else if (val == 2) {
                        $('#txtOptionA').val('');
                        $('#txtOptionB').val('');
                        $("#ddlCorrectAns").hide();
                        $("#ddlmCorrectAns").show();
                    }
                    else if (val == 3) {
                        $('#txtOptionA').val('True');
                        $('#txtOptionB').val('False');
                        $("#txtOptionA").attr("disabled", "disabled");
                        $("#txtOptionB").attr("disabled", "disabled");
                        $("#txtOptionC").attr("disabled", "disabled");
                        $("#txtOptionD").attr("disabled", "disabled");
                        $("#ddlmCorrectAns").hide();
                        $("#ddlCorrectAns").show();
                        $("#ddlCorrectAns").children('option:gt(1)').hide();
                    }
                }
                function oneditChange() {
                    debugger;
                    var val = $('#eddlQuesType').val();
                    if (val == "Single") {

                        $("#etxtOptionC").attr("disabled", false);
                        $("#etxtOptionD").attr("disabled", false);
                        $("#eddlmCorrectAns").hide();
                        $("#eddlCorrectAns").show();
                        $("#eddlCorrectAns").children('option:gt(1)').show();
                    }
                    else if (val == "Multiple") {

                        $("#eddlCorrectAns").hide();
                        $("#eddlmCorrectAns").show();
                    }
                    else if (val == "True/False") {
                        $('#etxtOptionA').val('True');
                        $('#etxtOptionB').val('False');

                        $("#etxtOptionA").attr("disabled", "disabled");
                        $("#etxtOptionB").attr("disabled", "disabled");
                        $("#etxtOptionC").attr("disabled", "disabled");
                        $("#etxtOptionD").attr("disabled", "disabled");
                        $("#eddlmCorrectAns").hide();
                        $("#eddlCorrectAns").show();
                        $("#eddlCorrectAns").children('option:gt(1)').hide();
                    }
                }
                function onRequestEdit(arg) {
                    console.log(arg.model);
                    var amodel = arg.model;
                    var validator = $("#EditQuestionForm").kendoValidator().data("kendoValidator");
                    if (validator.validate()) {
                        $("#loader").show();
                        var QuestionType = $('#eddlQuesType').data("kendoDropDownList").text();
                        var Category = $('#eddlCategory').data("kendoDropDownList").text();
                        var Question = $('#etxtQuestion').val();
                        var OptionA = $('#etxtOptionA').val();
                        var OptionB = $('#etxtOptionB').val();
                        var OptionC = $('#etxtOptionC').val();
                        var OptionD = $('#etxtOptionD').val();
                        var Answer = '';
                        var present = $('#eddlQuesType').data("kendoDropDownList").text() == "Multiple" ? true : false;
                        if (present) {
                            Answer = $('#eddlmCorrectAns').val();
                            Answer = Answer.toString();
                        } else {
                            Answer = $("#eddlCorrectAns").val();
                        }

                        var Editmodel = {

                            "QuestionType": QuestionType,
                            "Category": Category,
                            "Question": Question,
                            "OptionA": OptionA,
                            "OptionB": OptionB,
                            "OptionC": OptionC,
                            "OptionD": OptionD,
                            "Answer": Answer,
                            "SerialNumber" : amodel.SerialNumber
                        };

                        $.ajax({
                            url: '@Url.Action("EditQuestion", "Home")',
                            data: JSON.stringify(Editmodel),
                            type: 'POST',
                            contentType: 'application/json; charset=utf-8',
                            success: function (data) {

                                $("#loader").hide();

                                if (data == 1 || data == -1) {
                                    new PNotify({
                                        title: 'Success!',
                                        text: 'Record has been Updated.',
                                        type: 'success'
                                    });
                                    $("#gridQuestions").data("kendoGrid").dataSource.read();
                                }
                            }
                        });
                    }
                }
                $("#SaveQuestion").click(function () {
                    var validator = $("#addQuesModal").kendoValidator().data("kendoValidator");
                    if (validator.validate()) {
                        debugger;
                        var QuestionType = $('#ddlQuesType').data("kendoDropDownList").text();
                        var Category = $('#ddlCategory').data("kendoDropDownList").text();
                        var Question = $('#txtQuestion').val();
                        var OptionA = $('#txtOptionA').val();
                        var OptionB = $('#txtOptionB').val();
                        var OptionC = $('#txtOptionC').val();
                        var OptionD = $('#txtOptionD').val();
                        var Answer = '';
                        var present = $('#ddlQuesType').data("kendoDropDownList").text() == "Multiple" ? true : false;
                        if (present) {
                            Answer = $('#ddlmCorrectAns').val();
                            Answer = Answer.toString();
                        } else {
                            Answer = $("#ddlCorrectAns").val();
                        }

                        var model = {

                            "QuestionType": QuestionType,
                            "Category": Category,
                            "Question": Question,
                            "OptionA": OptionA,
                            "OptionB": OptionB,
                            "OptionC": OptionC,
                            "OptionD": OptionD,
                            "Answer": Answer

                        };

                        $.ajax(
                         {
                             url: '@Url.Action("AddQuestion", "Home")',
                             data: JSON.stringify(model),
                             type: 'POST',
                             contentType: 'application/json; charset=utf-8',
                             //dataType:"text",
                             success: function (data) {
                                 //alert("data");
                                 //alert(data);
                                 $("#loader").hide();
                                 if (data == 1 || data == -1) {
                                     $('#addQuesModal').modal('hide');
                                     new PNotify({
                                         title: 'Success!',
                                         text: 'Record has been Inserted.',
                                         type: 'success'
                                     });
                                     //ClearData();
                                     $("#gridQuestions").data("kendoGrid").dataSource.read();
                                 }
                                 else {
                                     $('#addQuesModal').modal('hide');
                                     new PNotify({
                                         title: 'Error!',
                                         text: 'Record Insertion Failed.',
                                         type: 'error'
                                     });
                                 }

                             }

                         }
              );

                    }
                });

                $("#ddlCategory").kendoDropDownList({
                    optionLabel: "Select Test Category",
                    filter: "startswith",
                    dataTextField: "SubjectName",
                    dataValueField: "SubjectId",
                    searchable: false,
                    dataSource: {
                        serverFiltering: false,
                        transport: {
                            read: {
                                url: '@Url.Action("ListSubjects", "Home")',
                                dataType: "json",
                            },
                            schema: {
                                model: {
                                    fields: {
                                        CategoryID: { type: "string" },
                                        CategoryName: { type: "string" }
                                    },
                                },
                            },
                        },
                    }
                }).data("kendoDropDownList");
                var dataSource = new kendo.data.DataSource({
                    transport: {

                        read: {
                            url: '@Url.Action("ListQuestions", "Home")',
                            dataType: "json" // "jsonp" is required for cross-domain requests; use "json" for same-domain requests
                        }
                    },
                    pageSize: 16
                });

                $("#gridQuestions").kendoGrid({
                    excel: {
                        allPages: true,
                        fileName: "Sales.xlsx"
                    },
                    dataSource: dataSource,
                    dataBound: function () {
                        var grid = $("#gridQuestions").data("kendoGrid");


                    },
                    scrollable: true,
                    sortable: true,
                    pageable: true,
                    autoBind: true,
                    resizable: true,
                    filterable: true,
                    columns: [


                    {
                        field: "SerialNumber",
                        hidden: true

                    }, {
                        field: "SubjectName",
                        title: "SubjectName",
                        width: 100
                    }, {
                        field: "Question",
                        title: "Question",
                        width: 150,

                    },
                    {
                        field: "Option1",
                        hidden: true

                    },
                    {
                        field: "Option2",
                        hidden: true

                    },
                    {
                        field: "Option3",
                        hidden: true

                    },
                    {
                        field: "Option4",
                        hidden: true

                    },
                    {
                        field: "Answer",
                        title: "Answer",
                        width: 50,

                    },
                    {
                        field: "ChoiceType",
                        title: "ChoiceType",
                        width: 50

                    }, {
                        command: [
                        { name: "edit", text: "Edit", template: "<a class='k-button k-grid-edit btn' href=''><i class='material-icons md-18'>mode_edit</i></a>" },
                        {
                            name: "Delete", text: "Delete", template: "<a class='k-button k-grid-Delete btn' href=''><i class='material-icons md-18'>delete</i></a>", click: function (e) {

                                e.preventDefault(); //prevent page scroll reset

                                var tr = $(e.target).closest("tr"); //get the row for deletion
                                var data = this.dataItem(tr); //get the row data so it can be referred later

                                kendo.confirm("Are you sure you want to delete this question?").then(function () {
                                    var Questionmodel = {
                                        "QId": data.SerialNumber
                                    }
                                    //$("#loader").show();

                                    $.ajax({
                                        url: '@Url.Action("DeleteQuestion", "Home")',
                                        data: JSON.stringify(Questionmodel),
                                        type: 'POST',
                                        contentType: 'application/json; charset=utf-8',
                                        success: function (data) {

                                            //$("#loader").hide();

                                            if (data == 1 || data == -1) {
                                                new PNotify({
                                                    title: 'Success!',
                                                    text: 'Record has been Deleted.',
                                                    type: 'success'
                                                });
                                                $("#gridQuestions").data("kendoGrid").dataSource.read();
                                            }
                                        }
                                    });
                                }, function () {
                                    //kendo.alert("You chose to Cancel action.");
                                });
                            }
                        }
                        ], title: "Action", width: "118px"
                    }],

                    editable: {
                        mode: "popup",
                        template: $("#EditQuestion").html(),
                        //update: true,
                        window: {
                            draggable: false
                        }
                    },
                    destroy: function (e) {

                        console.log(e);
                    },
                    edit: function (e) {

                        var ans = e.model.Answer;
                        ans = ans.split(",");
                        //var arr = arr.push();
                        console.log(ans);
                        var val = $('#eddlQuesType').val();
                        $("#eddlmCorrectAns").val(ans);
                        if (val == "Single") {

                            $("#etxtOptionC").attr("disabled", false);
                            $("#etxtOptionD").attr("disabled", false);
                            $("#eddlmCorrectAns").hide();
                            $("#eddlCorrectAns").show();
                            $("#eddlCorrectAns").children('option:gt(1)').show();
                        }
                        else if (val == "Multiple") {

                            $("#eddlCorrectAns").hide();
                            $("#eddlmCorrectAns").show();
                        }
                        else if (val == "True/False") {

                            $("#etxtOptionA").attr("disabled", "disabled");
                            $("#etxtOptionB").attr("disabled", "disabled");
                            $("#etxtOptionC").attr("disabled", "disabled");
                            $("#etxtOptionD").attr("disabled", "disabled");
                            $("#eddlmCorrectAns").hide();
                            $("#eddlCorrectAns").show();
                            $("#eddlCorrectAns").children('option:gt(1)').hide();
                        }
                       // $("#eddlQuesType").kendoDropDownList().data("kendoDropDownList");
                        $("#eddlQuesType").kendoDropDownList(
                       {
                           change: oneditChange
                       }).data("kendoDropDownList");
                        $("#eddlCategory").kendoDropDownList({
                            optionLabel: "Select Test Category",
                            filter: "startswith",
                            dataTextField: "SubjectName",
                            dataValueField: "SubjectName",
                            searchable: false,
                            dataSource: {
                                serverFiltering: false,
                                transport: {
                                    read: {
                                        url: '@Url.Action("ListSubjects", "Home")',
                                        dataType: "json",
                                    },
                                    schema: {
                                        model: {
                                            fields: {
                                                CategoryID: { type: "string" },
                                                CategoryName: { type: "string" }
                                            },
                                        },
                                    },
                                },
                            }
                        }).data("kendoDropDownList");

                        var updateBtn = e.container.find(".k-grid-update");
                        updateBtn.removeClass("k-grid-update"); //removing this class will prevent the grid from saving on click
                        updateBtn.click(function () {
                            onRequestEdit(e); //call the function you wish

                        });

                    }

                });

            });


</script>
